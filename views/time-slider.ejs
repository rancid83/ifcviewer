<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>

    <!-- jQuery & jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        
        .header {
            background-color: #ffffff;
            color: #2c3e50;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-bottom: 2px solid #e8ecef;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 95px);
            gap: 15px;
            padding: 15px;
        }
        
        .panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-left {
            flex: 1;
            min-width: 500px;
        }
        
        .panel-right {
            flex: 1;
            min-width: 500px;
        }
        
        .panel-header {
            background-color: #1e3a8a;
            color: #ffffff;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 2px solid #1e40af;
        }
        
        .panel-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-dark {
            background-color: #34495e;
            color: white;
        }
        
        .btn-dark:hover {
            background-color: #2c3e50;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        /* IFC ë·°ì–´ ì„¹ì…˜ */
        
        .viewer-section {
            margin-bottom: 20px;
        }
        
        #viewer-container {
            width: 100%;
            height: 400px;
            background-color: #ecf0f1;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            margin-top: 15px;
            position: relative;
        }
        
        #viewer-container canvas {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        /* ì‹œê°„ë³„ ì‚¬ìš©ëŸ‰ ë³´ê¸° ì„¹ì…˜ */
        
        .time-usage-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .time-usage-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .slider-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .slider-info-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .slider-info-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .slider-info-value {
            font-size: 16px;
            font-weight: 700;
            color: #3b82f6;
            font-family: 'Courier New', monospace;
        }
        
        .slider-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        #time-slider {
            margin: 15px 0;
        }
        
        .ui-slider-horizontal {
            height: 10px !important;
            border-radius: 5px;
            background: #e0e4e8;
            border: none;
        }
        
        .ui-slider-handle {
            width: 20px !important;
            height: 20px !important;
            border-radius: 50% !important;
            background: #3b82f6 !important;
            border: 3px solid white !important;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4) !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            cursor: pointer !important;
            outline: none !important;
        }
        
        .ui-slider-range {
            background: #3b82f6;
            border-radius: 5px;
        }
        
        .slider-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 14px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-control {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-control:hover {
            background-color: #5a6268;
        }
        
        .btn-play {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-play:hover {
            background-color: #2563eb;
        }
        
        .jump-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }
        
        .jump-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        #data-chart {
            width: 100%;
            height: 180px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .stat-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
        }
        /* Controller ë‹¤ì´ì–´ê·¸ë¨ ì„¹ì…˜ */
        
        .controller-section {
            margin-bottom: 20px;
        }
        
        .controller-diagram {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
            height: 300px;
            overflow: auto;
        }
        
        .diagram-title {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .info-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
        }
        
        .info-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .info-section ul {
            list-style: none;
            padding-left: 0;
            font-size: 13px;
        }
        
        .info-section li {
            margin-bottom: 5px;
            color: #374151;
        }
        
        .info-section strong {
            color: #1e40af;
        }
        
        .info-section code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: #dc2626;
        }
        /* ë°˜ì‘í˜• */
        
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .panel-left,
            .panel-right {
                min-width: 100%;
            }
            #viewer-container {
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>
            <%= title %>
        </h1>
    </div>

    <div class="main-container">
        <!-- ì¢Œì¸¡ íŒ¨ë„: ë¶„ì„ ê²°ê³¼ ë³´ê¸° -->
        <div class="panel panel-left">
            <div class="panel-header">
                ë¶„ì„ ê²°ê³¼ ë³´ê¸°
            </div>
            <div class="panel-content">
                <!-- IFC íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
                <div class="viewer-section">
                    <button class="btn btn-dark" id="load-ifc-btn">
                        ğŸ“‚ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (IFC)
                    </button>
                    <input type="file" id="ifc-file-input" accept=".ifc" style="display: none;">

                    <!-- IFC ë·°ì–´ -->
                    <div id="viewer-container">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #95a5a6;">
                            <p style="font-size: 16px; font-weight: 600;">IFC íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì— 3D ëª¨ë¸ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>

                <!-- ì‹œê°„ë³„ ì‚¬ìš©ëŸ‰ ë³´ê¸° (ê³ ê¸‰ ìŠ¬ë¼ì´ë”) -->
                <div class="time-usage-section">
                    <h3>â° ì‹œê°„ë³„ ì‚¬ìš©ëŸ‰ ë³´ê¸° (0~8000 step 0.1)</h3>

                    <!-- ìŠ¬ë¼ì´ë” ì •ë³´ -->
                    <div class="slider-info-grid">
                        <div class="slider-info-card">
                            <div class="slider-info-label">Current Step</div>
                            <div class="slider-info-value" id="step-display">0.0</div>
                        </div>
                        <div class="slider-info-card">
                            <div class="slider-info-label">Index</div>
                            <div class="slider-info-value" id="index-display">0</div>
                        </div>
                        <div class="slider-info-card">
                            <div class="slider-info-label">Value</div>
                            <div class="slider-info-value" id="value-display">--</div>
                        </div>
                        <div class="slider-info-card">
                            <div class="slider-info-label">Cache</div>
                            <div class="slider-info-value" id="cache-display">0</div>
                        </div>
                    </div>

                    <!-- ìŠ¬ë¼ì´ë” -->
                    <div class="slider-container">
                        <div id="time-slider"></div>
                    </div>

                    <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                    <div class="slider-controls">
                        <button class="btn-sm btn-control" id="btn-prev">â—€ -1</button>
                        <button class="btn-sm btn-play" id="btn-play">â–¶ Play</button>
                        <button class="btn-sm btn-control" id="btn-next">+1 â–¶</button>
                        <input type="number" class="jump-input" id="jump-input" placeholder="ì˜ˆ: 1234.5" step="0.1" min="0" max="8000">
                        <button class="btn-sm btn-play" id="btn-jump">Jump</button>
                        <button class="btn-sm btn-control" id="btn-reset">Reset</button>
                    </div>

                    <!-- ë°ì´í„° ì°¨íŠ¸ -->
                    <canvas id="data-chart"></canvas>

                    <!-- í†µê³„ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Min Value</div>
                            <div class="stat-value" id="stat-min">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Max Value</div>
                            <div class="stat-value" id="stat-max">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Value</div>
                            <div class="stat-value" id="stat-avg">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°ì¸¡ íŒ¨ë„: ë¶„ì„ ì„¤ì • í•˜ê¸° -->
        <div class="panel panel-right">
            <div class="panel-header">
                ë¶„ì„ ì„¤ì • í•˜ê¸°
            </div>
            <div class="panel-content">
                <!-- ë¶„ì„ í•˜ê¸° ë²„íŠ¼ -->
                <div style="margin-bottom: 20px; text-align: right;">
                    <button class="btn btn-dark" id="analyze-btn">
                        ğŸ”¬ ë¶„ì„ í•˜ê¸° (ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰)
                    </button>
                </div>

                <!-- Controller ë‹¤ì´ì–´ê·¸ë¨ -->
                <div class="controller-section">
                    <div class="controller-diagram">
                        <div class="diagram-title">ì‹œë®¬ë ˆì´ì…˜ í”Œë¡œìš°</div>
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <p style="margin-bottom: 15px;">ë°ì´í„° ì²˜ë¦¬ íë¦„ë„</p>
                            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                                <div style="padding: 10px 20px; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6; color: #1e40af; font-weight: 600;">
                                    Time Step (0.1 ë‹¨ìœ„)
                                </div>
                                <div style="font-size: 20px; color: #3b82f6;">â†“</div>
                                <div style="padding: 10px 20px; background: white; border-radius: 6px; border: 2px solid #d1d5db; font-weight: 600;">
                                    Chunk Loading (500ê°œ ë‹¨ìœ„)
                                </div>
                                <div style="font-size: 20px; color: #3b82f6;">â†“</div>
                                <div style="padding: 10px 20px; background: white; border-radius: 6px; border: 2px solid #d1d5db; font-weight: 600;">
                                    Cache & Prefetch
                                </div>
                                <div style="font-size: 20px; color: #3b82f6;">â†“</div>
                                <div style="padding: 10px 20px; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6; color: #1e40af; font-weight: 600;">
                                    Visualization
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- êµ¬í˜„ ì •ë³´ -->
                <div class="info-section">
                    <h3>âœ… êµ¬í˜„ ì™„ë£Œ ì‚¬í•­</h3>
                    <ul>
                        <li>âœ“ jQuery UI Slider: <strong>0 ~ 8000</strong>, step <strong>0.1</strong></li>
                        <li>âœ“ ì´ <strong>80,001ê°œ</strong> í¬ì¸íŠ¸ ì²˜ë¦¬</li>
                        <li>âœ“ <strong>Chunk ê¸°ë°˜ ë°ì´í„° ë¡œë”©</strong> (500ê°œ ë‹¨ìœ„) + ìºì‹œ</li>
                        <li>âœ“ <strong>Prefetch</strong> ì „ëµìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ íƒìƒ‰</li>
                        <li>âœ“ <code>slide</code> vs <code>change</code> ì´ë²¤íŠ¸ ë¶„ë¦¬</li>
                        <li>âœ“ ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ë³´ì •</li>
                        <li>âœ“ Canvas ê¸°ë°˜ ì‹¤ì‹œê°„ ì°¨íŠ¸</li>
                    </ul>

                    <h3 style="margin-top: 15px;">ğŸ“ í•µì‹¬ ìµœì í™”</h3>
                    <ul>
                        <li><strong>ì •ìˆ˜ ì¸ë±ìŠ¤ ìš´ì˜:</strong> step 0.1 = index 0~80000</li>
                        <li><strong>DOM ëˆˆê¸ˆ ìƒëµ:</strong> ë¸Œë¼ìš°ì € í”„ë¦¬ì§• ë°©ì§€</li>
                        <li><strong>ì´ë²¤íŠ¸ í•¸ë“¤ë§:</strong> slide(í‘œì‹œ) vs change(ì²˜ë¦¬)</li>
                        <li><strong>ë°ì´í„° ë¡œë”©:</strong> API chunk + prefetch</li>
                        <li><strong>ì¬ìƒ ê¸°ëŠ¥:</strong> setInterval ê¸°ë°˜, ë°°ì† ì¡°ì ˆ ê°€ëŠ¥</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAX_STEP = 8000;
        const MAX_INDEX = 80000;
        const CHUNK_SIZE = 500; // chunkë‹¹ 500ê°œ ì¸ë±ìŠ¤

        let currentIndex = 0;
        let playTimer = null;
        const cache = new Map();

        // DOM ìš”ì†Œ
        const $stepDisplay = $('#step-display');
        const $indexDisplay = $('#index-display');
        const $valueDisplay = $('#value-display');
        const $cacheDisplay = $('#cache-display');

        // ì¸ë±ìŠ¤ â†” Step ë³€í™˜
        function stepToIndex(step) {
            return Math.max(0, Math.min(MAX_INDEX, Math.round(step * 10)));
        }

        function indexToStep(index) {
            return (index / 10).toFixed(1);
        }

        // APIì—ì„œ chunk ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchChunk(index) {
            const chunkStart = Math.floor(index / CHUNK_SIZE) * CHUNK_SIZE;
            const chunkEnd = Math.min(MAX_INDEX, chunkStart + CHUNK_SIZE - 1);

            // ì´ë¯¸ ìºì‹œë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ
            if (cache.has(`chunk_${chunkStart}`)) return;

            try {
                const res = await fetch(`/api/timeseries?from=${chunkStart}&to=${chunkEnd}`);
                const json = await res.json();

                // chunk marker
                cache.set(`chunk_${chunkStart}`, true);

                // ë°ì´í„° ìºì‹±
                json.data.forEach(item => {
                    cache.set(item.index, item);
                });

                updateCacheDisplay();
            } catch (err) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err);
            }
        }

        // í˜„ì¬ index ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getData(index) {
            return cache.get(index);
        }

        // ìºì‹œ í¬ê¸° í‘œì‹œ
        function updateCacheDisplay() {
            const size = cache.size;
            $cacheDisplay.text(size.toLocaleString());
        }

        // Canvas ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function drawChart(dataPoint) {
            const canvas = document.getElementById('data-chart');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            // ë°°ê²½
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, w, h);

            // ê·¸ë¦¬ë“œ
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (h / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }

            if (!dataPoint) return;

            // ë°ì´í„° ë°”
            const value = dataPoint.value;
            const barHeight = (value / 100) * (h - 40);
            const barWidth = 60;
            const x = w / 2 - barWidth / 2;
            const y = h - barHeight - 20;

            // ê·¸ë¼ë°ì´ì…˜
            const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');

            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, barWidth, barHeight);

            // ê°’ í‘œì‹œ
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(value.toFixed(2), w / 2, y - 10);

            // Step í‘œì‹œ
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#6c757d';
            ctx.fillText(`Step: ${dataPoint.step}`, w / 2, h - 5);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const values = [];
            cache.forEach((val, key) => {
                if (typeof key === 'number' && val.value !== undefined) {
                    values.push(val.value);
                }
            });

            if (values.length > 0) {
                const min = Math.min(...values);
                const max = Math.max(...values);
                const avg = values.reduce((a, b) => a + b, 0) / values.length;

                $('#stat-min').text(min.toFixed(2));
                $('#stat-max').text(max.toFixed(2));
                $('#stat-avg').text(avg.toFixed(2));
            }
        }

        // ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
        async function render(index) {
            currentIndex = Math.max(0, Math.min(MAX_INDEX, index));
            const step = indexToStep(currentIndex);

            // UI ì—…ë°ì´íŠ¸
            $stepDisplay.text(step);
            $indexDisplay.text(currentIndex.toLocaleString());

            // í˜„ì¬ chunk ë¡œë”©
            await fetchChunk(currentIndex);

            // ì£¼ë³€ prefetch
            fetchChunk(currentIndex + CHUNK_SIZE);
            fetchChunk(currentIndex - CHUNK_SIZE);

            // ë°ì´í„° í‘œì‹œ
            const dataPoint = getData(currentIndex);
            if (dataPoint) {
                $valueDisplay.text(dataPoint.value.toFixed(2));
                drawChart(dataPoint);
                updateStats();
            }
        }

        // jQuery UI Slider ì´ˆê¸°í™”
        $('#time-slider').slider({
            min: 0,
            max: MAX_STEP,
            step: 0.1,
            value: 0,
            range: 'min',
            slide: function(event, ui) {
                // ë“œë˜ê·¸ ì¤‘ì—ëŠ” í‘œì‹œë§Œ
                const step = ui.value.toFixed(1);
                const index = stepToIndex(ui.value);
                $stepDisplay.text(step);
                $indexDisplay.text(index.toLocaleString());
            },
            change: function(event, ui) {
                // ì‹¤ì œ ë Œë”ë§ì€ ì—¬ê¸°ì„œ
                render(stepToIndex(ui.value));
            }
        });

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        $('#btn-prev').on('click', () => {
            const newStep = Math.max(0, parseFloat(indexToStep(currentIndex - 1)));
            $('#time-slider').slider('value', newStep);
        });

        $('#btn-next').on('click', () => {
            const newStep = Math.min(MAX_STEP, parseFloat(indexToStep(currentIndex + 1)));
            $('#time-slider').slider('value', newStep);
        });

        $('#btn-play').on('click', function() {
            if (playTimer) {
                clearInterval(playTimer);
                playTimer = null;
                $(this).html('â–¶ Play');
                return;
            }

            $(this).html('â¸ Pause');
            playTimer = setInterval(() => {
                if (currentIndex >= MAX_INDEX) {
                    clearInterval(playTimer);
                    playTimer = null;
                    $('#btn-play').html('â–¶ Play');
                    return;
                }

                const newIndex = currentIndex + 1;
                $('#time-slider').slider('value', parseFloat(indexToStep(newIndex)));
            }, 50); // 50ms = ë¹ ë¥¸ ì¬ìƒ
        });

        $('#btn-jump').on('click', () => {
            const input = parseFloat($('#jump-input').val());
            if (!isNaN(input) && input >= 0 && input <= MAX_STEP) {
                $('#time-slider').slider('value', input);
            }
        });

        $('#btn-reset').on('click', () => {
            $('#time-slider').slider('value', 0);
            $('#jump-input').val('');
        });

        // Enter í‚¤ë¡œ Jump
        $('#jump-input').on('keypress', (e) => {
            if (e.which === 13) {
                $('#btn-jump').click();
            }
        });

        // ì´ˆê¸° ë Œë”ë§
        render(0);
    </script>

    <!-- Three.js ë° IFC ë·°ì–´ -->
    <script async src="https://unpkg.com/es-module-shims@1.8.2/dist/es-module-shims.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/": "https://unpkg.com/three@0.160.0/", "web-ifc": "/js/web-ifc-api.js" } }
    </script>
    <script type="module">
        import * as THREE from 'three'; import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js'; import { IFCLoader } from '/js/IFCLoader.js'; // IFC ë·°ì–´ ì´ˆê¸°í™” const container = document.getElementById('viewer-container'); let scene, camera,
        renderer, controls, ifcLoader; let ifcModel = null; function initIFCViewer() { // Scene ì„¤ì • scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f2f5); // Camera ì„¤ì • const width = container.clientWidth; const height = container.clientHeight;
        camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000); camera.position.set(10, 10, 10); camera.lookAt(0, 0, 0); // Renderer ì„¤ì • renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(width, height); renderer.setPixelRatio(window.devicePixelRatio);
        container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì œê±° container.appendChild(renderer.domElement); // OrbitControls ì„¤ì • controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.05; // ì¡°ëª… ì¶”ê°€ const ambientLight
        = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8); directionalLight.position.set(10, 10, 5); scene.add(directionalLight); // Grid Helper const gridHelper = new
        THREE.GridHelper(20, 20, 0xcccccc, 0xeeeeee); scene.add(gridHelper); // IFC Loader ì„¤ì • ifcLoader = new IFCLoader(); ifcLoader.ifcManager.setWasmPath('/js/'); // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ animate(); // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ window.addEventListener('resize', onWindowResize, false);
        } function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); } function onWindowResize() { const width = container.clientWidth; const height = container.clientHeight; camera.aspect = width / height;
        camera.updateProjectionMatrix(); renderer.setSize(width, height); } // IFC íŒŒì¼ ë¡œë“œ í•¨ìˆ˜ async function loadIFCFile(file) { const url = URL.createObjectURL(file); try { // ê¸°ì¡´ ëª¨ë¸ ì œê±° if (ifcModel) { scene.remove(ifcModel); ifcModel = null; } // ìƒˆ ëª¨ë¸
        ë¡œë“œ ifcLoader.load( url, (model) => { scene.add(model); ifcModel = model; // ëª¨ë¸ì„ ì¤‘ì•™ì— ë°°ì¹˜ const box = new THREE.Box3().setFromObject(model); const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3()); const maxDim
        = Math.max(size.x, size.y, size.z); const fov = camera.fov * (Math.PI / 180); let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)); cameraZ *= 1.5; camera.position.set( center.x + cameraZ * 0.7, center.y + cameraZ * 0.7, center.z + cameraZ *
        0.7 ); camera.lookAt(center); controls.target.copy(center); controls.update(); console.log('IFC íŒŒì¼ ë¡œë“œ ì™„ë£Œ:', file.name); }, (progress) => { const percent = (progress.loaded / progress.total * 100).toFixed(0); console.log(`ë¡œë”© ì¤‘... ${percent}%`);
        }, (error) => { console.error('IFC ë¡œë“œ ì‹¤íŒ¨:', error); alert('IFC íŒŒì¼ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } ); } catch (error) { console.error('íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨:', error); alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); } finally { URL.revokeObjectURL(url); } } // ê¸°ë³¸ IFC íŒŒì¼ ë¡œë“œ (T-LAB_1126_re.ifc)
        async function loadDefaultIFC() { const url = '/files/T-LAB_1126_re.ifc'; try { // ê¸°ì¡´ ëª¨ë¸ ì œê±° if (ifcModel) { scene.remove(ifcModel); ifcModel = null; } ifcLoader.load( url, (model) => { scene.add(model); ifcModel = model; // ëª¨ë¸ì„ ì¤‘ì•™ì— ë°°ì¹˜ const box
        = new THREE.Box3().setFromObject(model); const center = box.getCenter(new THREE.Vector3()); const size = box.getSize(new THREE.Vector3()); const maxDim = Math.max(size.x, size.y, size.z); const fov = camera.fov * (Math.PI / 180); let cameraZ =
        Math.abs(maxDim / 2 / Math.tan(fov / 2)); cameraZ *= 1.5; camera.position.set( center.x + cameraZ * 0.7, center.y + cameraZ * 0.7, center.z + cameraZ * 0.7 ); camera.lookAt(center); controls.target.copy(center); controls.update(); console.log('ê¸°ë³¸
        IFC íŒŒì¼ ë¡œë“œ ì™„ë£Œ: T-LAB_1126_re.ifc'); }, (progress) => { const percent = (progress.loaded / progress.total * 100).toFixed(0); console.log(`ë¡œë”© ì¤‘... ${percent}%`); }, (error) => { console.error('IFC ë¡œë“œ ì‹¤íŒ¨:', error); } ); } catch (error) { console.error('íŒŒì¼
        ì²˜ë¦¬ ì‹¤íŒ¨:', error); } } // IFC ë·°ì–´ ì´ˆê¸°í™” initIFCViewer(); // ê¸°ë³¸ IFC íŒŒì¼ ìë™ ë¡œë“œ loadDefaultIFC(); // íŒŒì¼ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ document.getElementById('load-ifc-btn').addEventListener('click', () => { document.getElementById('ifc-file-input').click(); }); document.getElementById('ifc-file-input').addEventListener('change',
        (event) => { const file = event.target.files[0]; if (file && file.name.endsWith('.ifc')) { loadIFCFile(file); } else { alert('IFC íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); } });
    </script>
</body>

</html>